<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Advent of Code 2022</title>
    <style rel="stylesheet">
        html {
            background-color: #0f0f23;
            color: #ccc;
            font-family: 'Source Code Pro', monospace;
            padding: 0 1em;
        }
        html, select, textarea, button {
            font-size: 14pt;
        }
        h1 {
            color: #00cc00;
            font-size: 1.2em;
            line-height: 1em;
            padding-right: 0.5em;
        }
        @media (min-width:600px) {
            h1 {
                font-size: 1.5em;
            }
        }
        a, button {
            color: #009900;
            text-decoration: none;
        }
        a:hover, button:hover {
            color: #99ff99;
        }
        nav {
            display: table;
        }
        nav > * {
            display: table-cell;
            vertical-align: top;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 0.25em;
        }
        button, select, textarea, .component {
            background-color: #10101a;
            border: none;
        }
        select, textarea {
            color: #ccc;
        }
        select {
            padding: 0.25em 0.5em;
        }
        label {
            display: inline-block;
        }
        .component {
            border: 1px solid #333340;
            border-radius: 0.25em;
        }
        .input-container {
            height: 24em;
            max-width: 100%;
            padding: 0.75em;
            width: 56em;
        }
        textarea, .editor {
            height: 100%;
            resize: none;
            width: 100%;
        }
        textarea:focus {
            outline: none;
        }
        .editor {
            display: none;
            margin-left: -0.75em;
            width: calc(100% + 1.25em);
        }
        button {
            background: none;
            border: none;
            margin: 1em 0;
            padding: 0;
        }
        button:hover {
            cursor: pointer;
        }
        button:disabled {
            color: lightslategray;
            cursor: not-allowed;
        }
        table {
            border-collapse: collapse;
            line-height: 1em;
            margin-top: 1em;
        }
        thead tr th {
            border-top: solid gray 1px;
        }
        thead th {
            text-transform: uppercase;
        }
        th:not(:last-child), td:not(:last-child) {
            padding-right: 2em;
        }
        th:last-child, td:last-child {
            min-width: 5em;
        }
        th {
            text-align: left;
        }
        td {
            white-space: pre;
        }
        .error {
            color: red;
        }
        .resizable {
            background: url('https://api.iconify.design/mdi/resize-bottom-right.svg?color=%23ccc') #10101a no-repeat 100% 100%;
            box-sizing: border-box;
            overflow: hidden;
            touch-action: none;
        }
        .ascii {
            font-size: 12px;
            line-height: 12px;
            margin-top: 1em;
        }
        .ascii .background, .ascii .foreground {
            color: transparent;
        }
        .ascii .foreground {
            background-color: #ccc;
        }
    </style>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/editor/editor.main.min.css"
          integrity="sha512-GzcoZD7y5zvBofYtImXPZaPVhoY7xLPt+ysmbPb/vU+quSKFkcngxaSrxuwprDZL4MALUqGFmnqCxQZqMozv1Q=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <script>var manifest = {2021:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25],2022:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,20,21]}</script>
</head>
<body>
<nav>
    <h1 id="pageTitle">Advent of Code 2022</h1>
    <div>
        <a id="taskLink" href="#" target="_blank">[Task]</a>
        <a id="srcLink" href="#" target="_blank">[Source]</a>
    </div>
</nav>
<div style="margin: 1em 0">
    <label for="year">Year</label>
    <select class="component" id="year" name="year">
        <option value="2015">2015</option>
        <option value="2016">2016</option>
        <option value="2018">2018</option>
        <option value="2018">2018</option>
        <option value="2019">2019</option>
        <option value="2020">2020</option>
        <option value="2021">2021</option>
        <option value="2022" selected>2022</option>
    </select>
    <label for="day">Day</label>
    <select class="component" id="day" name="day">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
        <option value="19">19</option>
        <option value="20">20</option>
        <option value="21">21</option>
        <option value="22">22</option>
        <option value="23">23</option>
        <option value="24">24</option>
        <option value="25" selected>25</option>
    </select>
    <a id="prev">Prev</a> <a id="next">Next</a>
</div>
<div>
    <div>
        <div style="margin-bottom: 0.25em">
            <label><input type="checkbox" name="inputTextType" />load my input</label>
            <label><input type="checkbox" name="viewSource" />view source</label>
        </div>
        <div class="input-container component resizable">
            <textarea id="input" name="input" spellcheck="false">Loading ..</textarea>
            <div id="editor" class="editor"></div>
        </div>
    </div>
    <div>
        <button id="submit">[Solve]</button>
    </div>
</div>
<table>
    <thead>
    <tr>
        <th style="min-width: 4em">Part</th>
        <th style="width: 20em">Result</th>
        <th>Time</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <th>1.</th>
        <td id="partOneValue">-</td>
        <td id="partOneElapsed">-</td>
    </tr>
    <tr>
        <th>2.</th>
        <td id="partTwoValue">-</td>
        <td id="partTwoElapsed">-</td>
    </tr>
    </tbody>
</table>
<!-- load interact.js before monaco-editor to avoid issues -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/interact.js/1.10.17/interact.min.js"
        integrity="sha512-XcVj3UAxYb1bcxemjAU6ncOu6lhnuRz98icTuL+jrJE+2SCWFMZFc+5FaFsNikLKujDfL71c4LK5OBz1lsAKag=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>window.require = { paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs' } }</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.min.js"
        integrity="sha512-6bIYsGqvLpAiEBXPdRQeFf5cueeBECtAKJjIHer3BhBZNTV3WLcLA8Tm3pDfxUwTMIS+kAZwTUvJ1IrMdX8C5w=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/editor/editor.main.nls.min.js"
        integrity="sha512-CCv+DKWw+yZhxf4Z+ExT6HC5G+3S45TeMTYcJyYbdrv4BpK2vyALJ4FoVR/KGWDIPu7w4tNCOC9MJQIkYPR5FA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/editor/editor.main.min.js"
        integrity="sha512-u4eMtetNbBJvHXdLXs2kWZvJiVlg3cmkVcxrLzSPa1eNFuHygPYvyMWyK9PsD6Eq2MZSo+mTyjds8uuhPzVxHA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    if (Object.keys(manifest).length === 0) {
        const [nowDay, nowMonth, nowYear] = new Date().toLocaleString('en-GB', { timeZone: 'America/New_York' })
            .split(/[/,]/, 3)
            .map(s => parseInt(s, 10))
        const maxYear = nowMonth < 12 ? nowYear - 1 : nowYear
        for (let year = 2021; year <= maxYear; year++) {
            manifest[year] = [];
            const maxDay = year < maxYear || nowMonth < 12 ? 25 : Math.min(nowDay, 25)
            for (let day = 1; day <= maxDay; day++) {
                manifest[year].push(day)
            }
        }
    }
</script>
<script type="module">
    const baseUrl = `${window.location.origin}${window.location.pathname}`.replace(/\/[^/]*$/, '')
    const years = Object.keys(manifest).sort((a, b) => a - b)
    let year = years.concat().pop()
    let day = manifest[year].concat().pop()
    let objectURL, worker

    const titleElement           = document.getElementById('pageTitle')
    const taskLinkElement        = document.getElementById('taskLink')
    const srcLinkElement         = document.getElementById('srcLink')
    const yearElement            = document.getElementById('year')
    const dayElement             = document.getElementById('day')
    const prevElement            = document.getElementById('prev')
    const nextElement            = document.getElementById('next')
    const inputTextTypeInput     = document.querySelector('input[name="inputTextType"]')
    const viewSourceInput        = document.querySelector('input[name="viewSource"]')
    const inputElement           = document.getElementById('input')
    const editorElement          = document.getElementById('editor')
    const submitElement          = document.getElementById('submit')
    const partOneValueElement    = document.getElementById('partOneValue')
    const partOneElapsedElement  = document.getElementById('partOneElapsed')
    const partTwoValueElement    = document.getElementById('partTwoValue')
    const partTwoElapsedElement  = document.getElementById('partTwoElapsed')

    yearElement.onchange = (e) => setDay({ year: e.target.value })
    dayElement.onchange = (e) => setDay({ day: e.target.value })
    inputTextTypeInput.onchange = loadInputTextType
    viewSourceInput.onchange = showOrHideSource
    submitElement.onclick = submit

    const editorReady = new Promise(resolve => {
        let monacoIntervalId = setInterval(function () {
            if (typeof window.monaco === 'undefined') {
                return
            }
            clearInterval(monacoIntervalId)
            monacoIntervalId = undefined
            monaco.editor.defineTheme('advent-of-code', {
                base: 'vs-dark',
                inherit: true,
                rules: [],
                colors: {
                    'editor.background': '#10101a',
                    'editor.lineHighlightBackground': '#00990033',
                },
            });
            const editor = monaco.editor.create(editorElement, {
                automaticLayout: true,
                fontFamily: '"Source Code Pro", Menlo, Monaco, "Courier New", monospace',
                fontSize: '13px',
                language: 'javascript',
                minimap: { enabled: false },
                rulers: [80, 100, 120].map(column => ({ color: '#222', column })),
                scrollBeyondLastLine: false,
                theme: 'advent-of-code',
            })
            resolve(editor)
        }, 100)
    })

    function getDayStr() {
        return `0${day}`.slice(-2)
    }

    function terminateWorker() {
        if ( ! worker) {
            return
        }

        worker.terminate()
        worker = undefined
    }

    async function loadInputTextType() {
        terminateWorker()

        inputElement.value = 'Loading ..'

        const inputFile = inputTextTypeInput.checked ? 'input.txt' : 'sample.txt'

        try {
            inputElement.value = await fetch(`${year}/${getDayStr()}/${inputFile}`).then(response => response.text())
        } catch (e) {
            inputElement.value = e
        }
    }

    async function loadSource() {
        terminateWorker()
        const editor = await editorReady
        let src = await fetch(`${year}/${getDayStr()}/index.js`).then(response => response.text())
        src = src.replaceAll(/^import (.+) from '\.\.\/\.\.\//gm, `import $1 from '${baseUrl}/`)
        src = src.replaceAll(/^import (.+) from '\.\.\//gm, `import $1 from '${baseUrl}/${year}/`)
        src = src.replaceAll(/^import (.+) from '\.\//gm, `import $1 from '${baseUrl}/${year}/${day}/`)
        editor.setValue(src)
    }

    function showOrHideSource() {
        if (viewSourceInput.checked) {
            inputElement.style.display = 'none'
            editorElement.style.display = 'block'
        } else {
            inputElement.style.display = 'block'
            editorElement.style.display = 'none'
        }
    }

    function getSearch() {
        return window.location.href.match(/(\?[^#]+)/)?.[1] ?? ''
    }

    async function setDay(yearDayObj, pushState = true) {
        terminateWorker()

        if (typeof yearDayObj === 'object' && yearDayObj.year) {
            const currentYear = year
            year = parseInt(yearDayObj.year, 10)

            if ( ! (year in manifest)) {
                year = Object.keys(manifest).pop()
                pushState = true
            }

            if (year !== currentYear && ! yearDayObj.day) {
                day = manifest[year][0]
            }
        }

        [...yearElement.children].forEach(child => {
            child.style.display = parseInt(child.value, 10) in manifest ? 'inherit' : 'none'
        })

        const days = manifest[year]

        if (typeof yearDayObj === 'object' && yearDayObj.day) {
            day = parseInt(yearDayObj.day, 10)

            if ( ! days.includes(day)) {
                day = days[days.length - 1]
                pushState = true
            }
        }

        [...dayElement.children].forEach(child => {
            child.style.display = days.includes(parseInt(child.value, 10)) ? 'inherit' : 'none'
        })

        const search = getSearch()

        document.title                   = `Advent of Code ${year}: Day ${day}`
        titleElement.innerText           = document.title
        taskLinkElement.href             = `https://adventofcode.com/${year}/day/${day}`
        srcLinkElement.href              = `https://github.com/andrewmackrodt/advent-of-code/blob/main/src/${year}/${getDayStr()}/index.ts`
        yearElement.value                = year
        dayElement.value                 = day
        prevElement.style.display        = day > days[0] ? 'inline' : 'none'
        prevElement.href                 = `#!/year/${year}/day/${day - 1}/${search}`
        nextElement.style.display        = day < days[days.length - 1] ? 'inline' : 'none'
        nextElement.href                 = `#!/year/${year}/day/${day + 1}/${search}`
        partOneValueElement.innerText    = '-'
        partOneElapsedElement.innerText  = '-'
        partTwoValueElement.innerText    = '-'
        partTwoElapsedElement.innerText  = '-'

        await Promise.all([loadInputTextType(), loadSource()])

        if (pushState) {
            window.history.pushState({ year, day }, '', `${baseUrl}/index.html#!/year/${year}/day/${day}/${search}`)
        }
    }

    const hashRegExp = new RegExp(/\/year\/(20(?:1[5-9]|2[0-2]))\/day\/([1-9]|1[0-9]|2[0-5])\//)

    const [_, initialYear, initialDay] = hashRegExp.exec(window.location.hash) ?? []
    setDay({ year: initialYear, day: initialDay })
    window.onpopstate = ({ state }) => {
        if ( ! state) {
            const match = hashRegExp.exec(window.location.hash)
            if (match) {
                state = { year: match[1], day: match[2] }
            }
        }
        if ( ! state) {
            return
        }
        setDay(state, false)
    }

    async function sendToWorker(command, ...args) {
        return new Promise((resolve, reject) => {
            worker.onerror = reject
            worker.onmessage = ({ data: { value, error, elapsed } }) => {
                if ( ! error) resolve({ value, elapsed })
                else reject(error)
            }

            worker.postMessage([command, ...args])
        })
    }

    function convertModuleSsrc(src) {
        const srcEscaped = src.replaceAll('\\', '\\\\').replaceAll('`', '\\`').replaceAll('$', '\\$')

        return `
        async function __importScript(url) {
            const baseUrl = url.replace(/\\/[^/]+$/, '')
            const script = await fetch(url).then(res => res.text())
            return __evalScript(script, baseUrl)
        }

        async function __evalScript(script, baseUrl) {
            script = script.replaceAll(/^import (.+) from '([^']+)'/gm, "const $1 = await __importScript('$2')")
            script = script.replaceAll(/__importScript\\('\\./g, \`__importScript('\${baseUrl}/.\`)
            const exports = []
            for (const e of script.matchAll(/^export (?:class|const|function) ([A-Za-z0-9_]+)/gm)) {
                exports.push(e[1])
            }
            script = script.replaceAll(/^export /gm, '')
            script += ';\\nreturn { ' + exports.join(', ') + ' }'
            let promise
            eval('promise = (async function () { ' + script + ' })()')
            const module = { exports: await promise }
            return module.exports
        }

        ;(async function () {
            const module = await __evalScript(\`${srcEscaped}\`, '${baseUrl}');
            for (const [k, v] of Object.entries(module)) {
                globalThis[k] = v
            }
            postMessage(true)
        })()
        `
    }

    async function createWorker() {
        const env = getSearch().slice(1).split('&').reduce((qs, str) => {
            const [k, v] = str.split('=').map(s => decodeURIComponent(s))
            qs[k] = v
            return qs
        }, {})

        let src = await editorReady.then(editor => editor.getValue())
        let workerOptions = {}

        if ( ! navigator.userAgent.toLowerCase().includes('firefox')) {
            src += ';postMessage(true)'
            workerOptions = { type: 'module' }
        } else {
            // firefox does not support modules in workers, convert to non-module (very basic)
            src = convertModuleSsrc(src)
        }

        const js = `
        var process = {
            argv: ['', ''], env: ${JSON.stringify(env)},
            stdout: { write: (str) => console.log(str) },
            stderr: { write: (str) => console.error(str) },
        }

        let __input

        onmessage = async ({ data: [command, ...args] }) => {
            const result = { value: null, error: null, elapsed: -1 }

            try {
                const startedAt = performance.now()
                switch (command) {
                    case 'setInput':
                        __input = args[0]
                        break
                    case 1:
                        result.value = partOne(__input)
                        break
                    case 2:
                        result.value = partTwo(__input)
                        break
                }
                result.elapsed = Math.round((performance.now() - startedAt) * 10) / 10
            } catch (e) {
                result.error = e
            }

            postMessage(result)
        }

        ${src}
        `

        if (objectURL) window.URL.revokeObjectURL(objectURL)
        objectURL = window.URL.createObjectURL(new Blob([js], { type: 'text/javascript' }))
        worker = new Worker(objectURL, workerOptions)

        return new Promise((resolve, reject) => {
            worker.onerror = reject
            worker.onmessage = () => resolve(worker)
        })
    }

    async function submit() {
        partOneValueElement.innerText    = '-'
        partOneElapsedElement.innerText  = '-'
        partTwoValueElement.innerText    = '-'
        partTwoElapsedElement.innerText  = '-'
        submitElement.disabled           = true

        try {
            await createWorker()
            await sendToWorker('setInput', inputElement.value)

            for (const [valueElement, elapsedElement, arg] of [
                [partOneValueElement, partOneElapsedElement, 1],
                [partTwoValueElement, partTwoElapsedElement, 2],
            ]) {
                try {
                    valueElement.innerText = 'Calculating ..'
                    const { value, elapsed } = await sendToWorker(arg)
                    if (typeof value === 'string' && value.match(/^[#. \n]+$/)) {
                        valueElement.innerHTML = '<div class="ascii">' +
                            value.replaceAll(/\n/g, '<br>')
                                .replaceAll(/([. ])/g, '<span class="background">⬛️</span>')
                                .replaceAll(/#/g, '<span class="foreground">⬜️</span>') +
                            '</div>'
                    } else {
                        valueElement.innerText = value
                    }
                    elapsedElement.innerText = `${elapsed} ms`
                } catch (e) {
                    if (typeof e === 'object' && 'message' in e) {
                        e = e.message
                    }
                    valueElement.innerHTML = `<span class="error">ERROR: ${e}</span>`
                }
            }
        } catch (e) {
            if (typeof e === 'object' && 'message' in e) {
                e = e.message
            }
            partOneValueElement.innerHTML = `<span class="error">ERROR: ${e}</span>`
        }

        submitElement.disabled = false
    }
</script>
<script>
    interact('.resizable').resizable({
        edges: { bottom: true, right: true },
        listeners: {
            move: function (event) {
                let { x, y } = event.target.dataset

                x = (parseFloat(x) || 0) + event.deltaRect.left
                y = (parseFloat(y) || 0) + event.deltaRect.top

                Object.assign(event.target.style, {
                    width: `${event.rect.width}px`,
                    height: `${event.rect.height}px`,
                    transform: `translate(${x}px, ${y}px)`
                })

                Object.assign(event.target.dataset, { x, y })
            }
        }
    })
</script>
<script type="module">
    import * as Snow from 'https://cdn.jsdelivr.net/gh/radkinz/snow.js@aae2251/snow.js'
    const snowElement = document.createElement('div')
    snowElement.id = 'snow'
    snowElement.style.opacity = '0.5'
    document.body.appendChild(snowElement)
    new Snow.default({ id: 'snow', min_size: 1, max_size: 2 }).start()
    snowElement.style.zIndex = '-1'
</script>
</body>
</html>